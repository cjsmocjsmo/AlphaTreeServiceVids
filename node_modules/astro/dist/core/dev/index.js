import { polyfill } from "@astrojs/webapi";
import { performance } from "perf_hooks";
import { createVite } from "../create-vite.js";
import { defaultLogOptions, info, warn } from "../logger.js";
import * as vite from "vite";
import * as msg from "../messages.js";
import { getResolvedHostForVite } from "./util.js";
async function dev(config, options = { logging: defaultLogOptions }) {
  var _a;
  const devStart = performance.now();
  polyfill(globalThis, {
    exclude: "window document"
  });
  const host = getResolvedHostForVite(config);
  const viteUserConfig = vite.mergeConfig({
    mode: "development",
    server: { host }
  }, config.vite || {});
  const viteConfig = await createVite(viteUserConfig, { astroConfig: config, logging: options.logging, mode: "dev" });
  const viteServer = await vite.createServer(viteConfig);
  await viteServer.listen(config.devOptions.port);
  const devServerAddressInfo = viteServer.httpServer.address();
  const site = config.buildOptions.site ? new URL(config.buildOptions.site) : void 0;
  info(options.logging, null, msg.devStart({ startupTime: performance.now() - devStart, config, devServerAddressInfo, site, https: !!((_a = viteUserConfig.server) == null ? void 0 : _a.https) }));
  const currentVersion = "0.24.0";
  if (currentVersion.includes("-")) {
    warn(options.logging, null, msg.prerelease({ currentVersion }));
  }
  return {
    address: devServerAddressInfo,
    stop: () => viteServer.close()
  };
}
export {
  dev as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvZGV2L2luZGV4LnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBQUE7QUFFQTtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFZQSxtQkFBa0MsUUFBcUIsVUFBc0IsRUFBRSxTQUFTLGtCQUFrQixHQUF1QjtBQXBCakk7QUFxQkMsUUFBTSxXQUFXLFlBQVksSUFBSTtBQUVqQyxXQUFTLFlBQVk7QUFBQSxJQUNwQixTQUFTO0FBQUEsRUFDVixDQUFDO0FBR0QsUUFBTSxPQUFPLHVCQUF1QixNQUFNO0FBQzFDLFFBQU0saUJBQWlCLEtBQUssWUFDM0I7QUFBQSxJQUNDLE1BQU07QUFBQSxJQUNOLFFBQVEsRUFBRSxLQUFLO0FBQUEsRUFDaEIsR0FDQSxPQUFPLFFBQVEsQ0FBQyxDQUNqQjtBQUNBLFFBQU0sYUFBYSxNQUFNLFdBQVcsZ0JBQWdCLEVBQUUsYUFBYSxRQUFRLFNBQVMsUUFBUSxTQUFTLE1BQU0sTUFBTSxDQUFDO0FBQ2xILFFBQU0sYUFBYSxNQUFNLEtBQUssYUFBYSxVQUFVO0FBQ3JELFFBQU0sV0FBVyxPQUFPLE9BQU8sV0FBVyxJQUFJO0FBRTlDLFFBQU0sdUJBQXVCLFdBQVcsV0FBWSxRQUFRO0FBQzVELFFBQU0sT0FBTyxPQUFPLGFBQWEsT0FBTyxJQUFJLElBQUksT0FBTyxhQUFhLElBQUksSUFBSTtBQUM1RSxPQUFLLFFBQVEsU0FBUyxNQUFNLElBQUksU0FBUyxFQUFFLGFBQWEsWUFBWSxJQUFJLElBQUksVUFBVSxRQUFRLHNCQUFzQixNQUFNLE9BQU8sQ0FBQyxDQUFDLHNCQUFlLFdBQWYsbUJBQXVCLE9BQU0sQ0FBQyxDQUFDO0FBRWxLLFFBQU0saUJBQWlCO0FBQ3ZCLE1BQUksZUFBZSxTQUFTLEdBQUcsR0FBRztBQUNqQyxTQUFLLFFBQVEsU0FBUyxNQUFNLElBQUksV0FBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBQUEsRUFDL0Q7QUFFQSxTQUFPO0FBQUEsSUFDTixTQUFTO0FBQUEsSUFDVCxNQUFNLE1BQU0sV0FBVyxNQUFNO0FBQUEsRUFDOUI7QUFDRDsiLAogICJuYW1lcyI6IFtdCn0K

import { fileURLToPath } from "url";
import { getStylesForURL } from "./css.js";
import { injectTags } from "./html.js";
import { resolveRenderers } from "./renderers.js";
import { errorHandler } from "./error.js";
import { getHmrScript } from "./hmr.js";
import { prependForwardSlash } from "../../path.js";
import { render as coreRender } from "../core.js";
import { createModuleScriptElementWithSrcSet } from "../ssr-element.js";
const svelteStylesRE = /svelte\?svelte&type=style/;
async function preload({ astroConfig, filePath, viteServer }) {
  const renderers = await resolveRenderers(viteServer, astroConfig);
  const mod = await viteServer.ssrLoadModule(fileURLToPath(filePath));
  return [renderers, mod];
}
async function render(renderers, mod, ssrOpts) {
  const { astroConfig, filePath, logging, mode, origin, pathname, route, routeCache, viteServer } = ssrOpts;
  const legacy = astroConfig.buildOptions.legacyBuild;
  const scripts = createModuleScriptElementWithSrcSet(!legacy && mod.hasOwnProperty("$$metadata") ? Array.from(mod.$$metadata.hoistedScriptPaths()) : []);
  if (mod.hasOwnProperty("$$metadata") && mode === "development" && !legacy) {
    scripts.add({
      props: { type: "module", src: "/@vite/client" },
      children: ""
    });
    scripts.add({
      props: { type: "module", src: new URL("../../../runtime/client/hmr.js", import.meta.url).pathname },
      children: ""
    });
  }
  let links = /* @__PURE__ */ new Set();
  if (!legacy) {
    [...getStylesForURL(filePath, viteServer)].forEach((href) => {
      if (mode === "development" && svelteStylesRE.test(href)) {
        scripts.add({
          props: { type: "module", src: href },
          children: ""
        });
      } else {
        links.add({
          props: {
            rel: "stylesheet",
            href,
            "data-astro-injected": true
          },
          children: ""
        });
      }
    });
  }
  let content = await coreRender({
    legacyBuild: astroConfig.buildOptions.legacyBuild,
    links,
    logging,
    markdownRender: astroConfig.markdownOptions.render,
    mod,
    origin,
    pathname,
    scripts,
    async resolve(s) {
      if (!astroConfig.buildOptions.legacyBuild) {
        const [, resolvedPath] = await viteServer.moduleGraph.resolveUrl(s);
        return "/@fs" + prependForwardSlash(resolvedPath);
      } else {
        return s;
      }
    },
    renderers,
    route,
    routeCache,
    site: astroConfig.buildOptions.site
  });
  if ((route == null ? void 0 : route.type) === "endpoint") {
    return content;
  }
  const tags = [];
  if (mode === "development" && legacy) {
    tags.push({
      tag: "script",
      attrs: { type: "module" },
      children: await getHmrScript(),
      injectTo: "head"
    });
  }
  if (legacy) {
    [...getStylesForURL(filePath, viteServer)].forEach((href) => {
      if (mode === "development" && svelteStylesRE.test(href)) {
        tags.push({
          tag: "script",
          attrs: { type: "module", src: href },
          injectTo: "head"
        });
      } else {
        tags.push({
          tag: "link",
          attrs: {
            rel: "stylesheet",
            href,
            "data-astro-injected": true
          },
          injectTo: "head"
        });
      }
    });
  }
  content = injectTags(content, tags);
  if (mode === "development" && astroConfig.buildOptions.legacyBuild) {
    const relativeURL = filePath.href.replace(astroConfig.projectRoot.href, "/");
    content = await viteServer.transformIndexHtml(relativeURL, content, pathname);
  }
  if (!/<!doctype html/i.test(content)) {
    content = "<!DOCTYPE html>\n" + content;
  }
  return content;
}
async function ssr(preloadedComponent, ssrOpts) {
  try {
    const [renderers, mod] = preloadedComponent;
    return await render(renderers, mod, ssrOpts);
  } catch (e) {
    await errorHandler(e, { viteServer: ssrOpts.viteServer, filePath: ssrOpts.filePath });
    throw e;
  }
}
export {
  preload,
  render,
  ssr
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vLi4vc3JjL2NvcmUvcmVuZGVyL2Rldi9pbmRleC50cyJdLAogICJtYXBwaW5ncyI6ICJBQUdBO0FBQ0E7QUFDQTtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQXlCQSxNQUFNLGlCQUFpQjtBQUV2Qix1QkFBOEIsRUFBRSxhQUFhLFVBQVUsY0FBc0c7QUFFNUosUUFBTSxZQUFZLE1BQU0saUJBQWlCLFlBQVksV0FBVztBQUVoRSxRQUFNLE1BQU8sTUFBTSxXQUFXLGNBQWMsY0FBYyxRQUFRLENBQUM7QUFFbkUsU0FBTyxDQUFDLFdBQVcsR0FBRztBQUN2QjtBQUdBLHNCQUE2QixXQUF1QixLQUF3QixTQUFzQztBQUNqSCxRQUFNLEVBQUUsYUFBYSxVQUFVLFNBQVMsTUFBTSxRQUFRLFVBQVUsT0FBTyxZQUFZLGVBQWU7QUFDbEcsUUFBTSxTQUFTLFlBQVksYUFBYTtBQUd4QyxRQUFNLFVBQVUsb0NBQW9DLENBQUMsVUFBVSxJQUFJLGVBQWUsWUFBWSxJQUFJLE1BQU0sS0FBSyxJQUFJLFdBQVcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7QUFHdEosTUFBSSxJQUFJLGVBQWUsWUFBWSxLQUFLLFNBQVMsaUJBQWlCLENBQUMsUUFBUTtBQUMxRSxZQUFRLElBQUk7QUFBQSxNQUNYLE9BQU8sRUFBRSxNQUFNLFVBQVUsS0FBSyxnQkFBZ0I7QUFBQSxNQUM5QyxVQUFVO0FBQUEsSUFDWCxDQUFDO0FBQ0QsWUFBUSxJQUFJO0FBQUEsTUFDWCxPQUFPLEVBQUUsTUFBTSxVQUFVLEtBQUssSUFBSSxJQUFJLGtDQUFrQyxZQUFZLEdBQUcsRUFBRSxTQUFTO0FBQUEsTUFDbEcsVUFBVTtBQUFBLElBQ1gsQ0FBQztBQUFBLEVBQ0Y7QUFHQSxNQUFJLFFBQVEsb0JBQUksSUFBZ0I7QUFDaEMsTUFBSSxDQUFDLFFBQVE7QUFDWixLQUFDLEdBQUcsZ0JBQWdCLFVBQVUsVUFBVSxDQUFDLEVBQUUsUUFBUSxDQUFDLFNBQVM7QUFD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

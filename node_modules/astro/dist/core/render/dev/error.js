import eol from "eol";
import fs from "fs";
import { codeFrame } from "../../util.js";
async function errorHandler(e, { viteServer, filePath }) {
  if (e.stack) {
    e.stack = eol.lf(e.stack);
  }
  if (e instanceof Error) {
    viteServer.ssrFixStacktrace(e);
  }
  if (Array.isArray(e.errors)) {
    const { location, pluginName, text } = e.errors[0];
    const err = e;
    if (location)
      err.loc = { file: location.file, line: location.line, column: location.column };
    let src = err.pluginCode;
    if (!src && err.id && fs.existsSync(err.id))
      src = await fs.promises.readFile(err.id, "utf8");
    if (!src)
      src = await fs.promises.readFile(filePath, "utf8");
    err.frame = codeFrame(src, err.loc);
    err.id = location == null ? void 0 : location.file;
    err.message = `${location == null ? void 0 : location.file}: ${text}
${err.frame}
`;
    if (pluginName)
      err.plugin = pluginName;
    throw err;
  }
  throw e;
}
export {
  errorHandler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vLi4vc3JjL2NvcmUvcmVuZGVyL2Rldi9lcnJvci50cyJdLAogICJtYXBwaW5ncyI6ICJBQUlBO0FBQ0E7QUFDQTtBQU9BLDRCQUFtQyxHQUFZLEVBQUUsWUFBWSxZQUFpQztBQUU3RixNQUFLLEVBQVUsT0FBTztBQUNyQixJQUFDLEVBQVUsUUFBUSxJQUFJLEdBQUksRUFBVSxLQUFLO0FBQUEsRUFDM0M7QUFHQSxNQUFJLGFBQWEsT0FBTztBQUN2QixlQUFXLGlCQUFpQixDQUFDO0FBQUEsRUFDOUI7QUFHQSxNQUFJLE1BQU0sUUFBUyxFQUFVLE1BQU0sR0FBRztBQUNyQyxVQUFNLEVBQUUsVUFBVSxZQUFZLFNBQVUsRUFBa0IsT0FBTztBQUNqRSxVQUFNLE1BQU07QUFDWixRQUFJO0FBQVUsVUFBSSxNQUFNLEVBQUUsTUFBTSxTQUFTLE1BQU0sTUFBTSxTQUFTLE1BQU0sUUFBUSxTQUFTLE9BQU87QUFDNUYsUUFBSSxNQUFNLElBQUk7QUFDZCxRQUFJLENBQUMsT0FBTyxJQUFJLE1BQU0sR0FBRyxXQUFXLElBQUksRUFBRTtBQUFHLFlBQU0sTUFBTSxHQUFHLFNBQVMsU0FBUyxJQUFJLElBQUksTUFBTTtBQUM1RixRQUFJLENBQUM7QUFBSyxZQUFNLE1BQU0sR0FBRyxTQUFTLFNBQVMsVUFBVSxNQUFNO0FBQzNELFFBQUksUUFBUSxVQUFVLEtBQUssSUFBSSxHQUFHO0FBQ2xDLFFBQUksS0FBSyxxQ0FBVTtBQUNuQixRQUFJLFVBQVUsR0FBRyxxQ0FBVSxTQUFTO0FBQUEsRUFDcEMsSUFBSTtBQUFBO0FBRUosUUFBSTtBQUFZLFVBQUksU0FBUztBQUM3QixVQUFNO0FBQUEsRUFDUDtBQUdBLFFBQU07QUFDUDsiLAogICJuYW1lcyI6IFtdCn0K

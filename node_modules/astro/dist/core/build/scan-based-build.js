import { fileURLToPath } from "url";
import * as vite from "vite";
import { createBuildInternals } from "../../core/build/internal.js";
import { rollupPluginAstroBuildHTML } from "../../vite-plugin-build-html/index.js";
import { rollupPluginAstroBuildCSS } from "../../vite-plugin-build-css/index.js";
function entryIsType(type) {
  return function withPage([_, pageData]) {
    return pageData.route.type === type;
  };
}
function reduceEntries(acc, [key, value]) {
  acc[key] = value;
  return acc;
}
function routesOfType(type, allPages) {
  return Object.entries(allPages).filter(entryIsType(type)).reduce(reduceEntries, {});
}
async function build(opts) {
  const { allPages, astroConfig, logging, origin, pageNames, routeCache, viteConfig, viteServer } = opts;
  const internals = createBuildInternals();
  return await vite.build({
    logLevel: "error",
    mode: "production",
    build: {
      emptyOutDir: true,
      minify: "esbuild",
      outDir: fileURLToPath(astroConfig.dist),
      rollupOptions: {
        input: [],
        output: {
          format: "esm"
        }
      },
      target: "es2020"
    },
    plugins: [
      rollupPluginAstroBuildHTML({
        astroConfig,
        internals,
        logging,
        origin,
        allPages: routesOfType("page", allPages),
        pageNames,
        routeCache,
        viteServer
      }),
      rollupPluginAstroBuildCSS({
        internals
      }),
      ...viteConfig.plugins || []
    ],
    publicDir: viteConfig.publicDir,
    root: viteConfig.root,
    envPrefix: "PUBLIC_",
    server: viteConfig.server,
    base: astroConfig.buildOptions.site ? new URL(astroConfig.buildOptions.site).pathname : "/"
  });
}
export {
  build
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGQvc2Nhbi1iYXNlZC1idWlsZC50cyJdLAogICJtYXBwaW5ncyI6ICJBQU1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFlQSxxQkFBcUIsTUFBaUI7QUFDckMsU0FBTyxrQkFBa0IsQ0FBQyxHQUFHLFdBQW9DO0FBQ2hFLFdBQU8sU0FBUyxNQUFNLFNBQVM7QUFBQSxFQUNoQztBQUNEO0FBR0EsdUJBQTBCLEtBQTJCLENBQUMsS0FBSyxRQUFxQjtBQUMvRSxNQUFJLE9BQU87QUFDWCxTQUFPO0FBQ1I7QUFHQSxzQkFBc0IsTUFBaUIsVUFBd0I7QUFDOUQsU0FBTyxPQUFPLFFBQVEsUUFBUSxFQUFFLE9BQU8sWUFBWSxJQUFJLENBQUMsRUFBRSxPQUFPLGVBQWUsQ0FBQyxDQUFDO0FBQ25GO0FBRUEscUJBQTRCLE1BQTZCO0FBQ3hELFFBQU0sRUFBRSxVQUFVLGFBQWEsU0FBUyxRQUFRLFdBQVcsWUFBWSxZQUFZLGVBQWU7QUFHbEcsUUFBTSxZQUFZLHFCQUFxQjtBQUV2QyxTQUFPLE1BQU0sS0FBSyxNQUFNO0FBQUEsSUFDdkIsVUFBVTtBQUFBLElBQ1YsTUFBTTtBQUFBLElBQ04sT0FBTztBQUFBLE1BQ04sYUFBYTtBQUFBLE1BQ2IsUUFBUTtBQUFBLE1BQ1IsUUFBUSxjQUFjLFlBQVksSUFBSTtBQUFBLE1BQ3RDLGVBQWU7QUFBQSxRQUVkLE9BQU8sQ0FBQztBQUFBLFFBQ1IsUUFBUTtBQUFBLFVBQ1AsUUFBUTtBQUFBLFFBQ1Q7QUFBQSxNQUNEO0FBQUEsTUFDQSxRQUFRO0FBQUEsSUFDVDtBQUFBLElBQ0EsU0FBUztBQUFBLE1BQ1IsMkJBQTJCO0FBQUEsUUFDMUI7QUFBQSxRQUNBO0FBQUEsUUFDQTtBQUFBLFFBQ0E7QUFBQSxRQUNBLFVBQVUsYUFBYSxRQUFRLFFBQVE7QUFBQSxRQUN2QztBQUFBLFFBQ0E7QUFBQSxRQUNBO0FBQUEsTUFDRCxDQUFDO0FBQUEsTUFDRCwwQkFBMEI7QUFBQSxRQUN6QjtBQUFBLE1BQ0QsQ0FBQztBQUFBLE1BQ0QsR0FBSSxXQUFXLFdBQVcsQ0FBQztBQUFBLElBQzVCO0FBQUEsSUFDQSxXQUFXLFdBQVc7QUFBQSxJQUN0QixNQUFNLFdBQVc7QUFBQSxJQUNqQixXQUFXO0FBQUEsSUFDWCxRQUFRLFdBQVc7QUFBQSxJQUNuQixNQUFNLFlBQVksYUFBYSxPQUFPLElBQUksSUFBSSxZQUFZLGFBQWEsSUFBSSxFQUFFLFdBQVc7QUFBQSxFQUN6RixDQUFDO0FBQ0Y7IiwKICAibmFtZXMiOiBbXQp9Cg==

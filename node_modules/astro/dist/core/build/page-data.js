import { fileURLToPath } from "url";
import * as colors from "kleur/colors";
import { debug } from "../logger.js";
import { preload as ssrPreload } from "../render/dev/index.js";
import { generateRssFunction } from "../render/rss.js";
import { callGetStaticPaths } from "../render/route-cache.js";
async function collectPagesData(opts) {
  var _a;
  const { astroConfig, logging, manifest, origin, routeCache, viteServer } = opts;
  const assets = {};
  const allPages = {};
  for (const route of manifest.routes) {
    if (route.pathname) {
      allPages[route.component] = {
        route,
        paths: [route.pathname],
        preload: await ssrPreload({
          astroConfig,
          filePath: new URL(`./${route.component}`, astroConfig.projectRoot),
          viteServer
        }).then((routes) => {
          const html = `${route.pathname}`.replace(/\/?$/, "/index.html");
          debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.green("\u2714"))} ${route.component} \u2192 ${colors.yellow(html)}`);
          return routes;
        }).catch((err) => {
          debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.red("\u2718"))} ${route.component}`);
          throw err;
        })
      };
      continue;
    }
    const result = await getStaticPathsForRoute(opts, route).then((_result) => {
      const label = _result.staticPaths.length === 1 ? "page" : "pages";
      debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.green("\u2714"))} ${route.component} \u2192 ${colors.magenta(`[${_result.staticPaths.length} ${label}]`)}`);
      return _result;
    }).catch((err) => {
      debug("build", `\u251C\u2500\u2500 ${colors.bold(colors.red("\u2717"))} ${route.component}`);
      throw err;
    });
    const rssFn = generateRssFunction(astroConfig.buildOptions.site, route);
    for (const rssCallArg of result.rss) {
      const rssResult = rssFn(rssCallArg);
      if (rssResult.xml) {
        const { url, content } = rssResult.xml;
        if (content) {
          const rssFile = new URL(url.replace(/^\/?/, "./"), astroConfig.dist);
          if (assets[fileURLToPath(rssFile)]) {
            throw new Error(`[getStaticPaths] RSS feed ${url} already exists.
Use \`rss(data, {url: '...'})\` to choose a unique, custom URL. (${route.component})`);
          }
          assets[fileURLToPath(rssFile)] = content;
        }
      }
      if ((_a = rssResult.xsl) == null ? void 0 : _a.content) {
        const { url, content } = rssResult.xsl;
        const stylesheetFile = new URL(url.replace(/^\/?/, "./"), astroConfig.dist);
        if (assets[fileURLToPath(stylesheetFile)]) {
          throw new Error(`[getStaticPaths] RSS feed stylesheet ${url} already exists.
Use \`rss(data, {stylesheet: '...'})\` to choose a unique, custom URL. (${route.component})`);
        }
        assets[fileURLToPath(stylesheetFile)] = content;
      }
    }
    const finalPaths = result.staticPaths.map((staticPath) => staticPath.params && route.generate(staticPath.params)).filter(Boolean);
    allPages[route.component] = {
      route,
      paths: finalPaths,
      preload: await ssrPreload({
        astroConfig,
        filePath: new URL(`./${route.component}`, astroConfig.projectRoot),
        viteServer
      })
    };
  }
  return { assets, allPages };
}
async function getStaticPathsForRoute(opts, route) {
  const { astroConfig, logging, routeCache, viteServer } = opts;
  if (!viteServer)
    throw new Error(`vite.createServer() not called!`);
  const filePath = new URL(`./${route.component}`, astroConfig.projectRoot);
  const mod = await viteServer.ssrLoadModule(fileURLToPath(filePath));
  const result = await callGetStaticPaths(mod, route, false, logging);
  routeCache.set(route, result);
  return result;
}
export {
  collectPagesData
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGQvcGFnZS1kYXRhLnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBaUJBLGdDQUF1QyxNQUFnRTtBQTNCdkc7QUE0QkMsUUFBTSxFQUFFLGFBQWEsU0FBUyxVQUFVLFFBQVEsWUFBWSxlQUFlO0FBRTNFLFFBQU0sU0FBaUMsQ0FBQztBQUN4QyxRQUFNLFdBQXlCLENBQUM7QUFNaEMsYUFBVyxTQUFTLFNBQVMsUUFBUTtBQUVwQyxRQUFJLE1BQU0sVUFBVTtBQUNuQixlQUFTLE1BQU0sYUFBYTtBQUFBLFFBQzNCO0FBQUEsUUFDQSxPQUFPLENBQUMsTUFBTSxRQUFRO0FBQUEsUUFDdEIsU0FBUyxNQUFNLFdBQVc7QUFBQSxVQUN6QjtBQUFBLFVBQ0EsVUFBVSxJQUFJLElBQUksS0FBSyxNQUFNLGFBQWEsWUFBWSxXQUFXO0FBQUEsVUFDakU7QUFBQSxRQUNELENBQUMsRUFDQyxLQUFLLENBQUMsV0FBVztBQUNqQixnQkFBTSxPQUFPLEdBQUcsTUFBTSxXQUFXLFFBQVEsUUFBUSxhQUFhO0FBQzlELGdCQUFNLFNBQVMsc0JBQU8sT0FBTyxLQUFLLE9BQU8sTUFBTSxRQUFHLENBQUMsS0FBSyxNQUFNLG9CQUFlLE9BQU8sT0FBTyxJQUFJLEdBQUc7QUFDbEcsaUJBQU87QUFBQSxRQUNSLENBQUMsRUFDQSxNQUFNLENBQUMsUUFBUTtBQUNmLGdCQUFNLFNBQVMsc0JBQU8sT0FBTyxLQUFLLE9BQU8sSUFBSSxRQUFHLENBQUMsS0FBSyxNQUFNLFdBQVc7QUFDdkUsZ0JBQU07QUFBQSxRQUNQLENBQUM7QUFBQSxNQUNIO0FBQ0E7QUFBQSxJQUNEO0FBRUEsVUFBTSxTQUFTLE1BQU0sdUJBQXVCLE1BQU0sS0FBSyxFQUNyRCxLQUFLLENBQUMsWUFBWTtBQUNsQixZQUFNLFFBQVEsUUFBUSxZQUFZLFdBQVcsSUFBSSxTQUFTO0FBQzFELFlBQU0sU0FBUyxzQkFBTyxPQUFPLEtBQUssT0FBTyxNQUFNLFFBQUcsQ0FBQyxLQUFLLE1BQU0sb0JBQWUsT0FBTyxRQUFRLElBQUksUUFBUSxZQUFZLFVBQVUsUUFBUSxHQUFHO0FBQ3pJLGFBQU87QUFBQSxJQUNSLENBQUMsRUFDQSxNQUFNLENBQUMsUUFBUTtBQUNmLFlBQU0sU0FBUyxzQkFBTyxPQUFPLEtBQUssT0FBTyxJQUFJLFFBQUcsQ0FBQyxLQUFLLE1BQU0sV0FBVztBQUN2RSxZQUFNO0FBQUEsSUFDUCxDQUFDO0FBQ0YsVUFBTSxRQUFRLG9CQUFvQixZQUFZLGFBQWEsTUFBTSxLQUFLO0FBQ3RFLGVBQVcsY0FBYyxPQUFPLEtBQUs7QUFDcEMsWUFBTSxZQUFZLE1BQU0sVUFBVTtBQUNsQyxVQUFJLFVBQVUsS0FBSztBQUNsQixjQUFNLEVBQUUsS0FBSyxZQUFZLFVBQVU7QUFDbkMsWUFBSSxTQUFTO0FBQ1osZ0JBQU0sVUFBVSxJQUFJLElBQUksSUFBSSxRQUFRLFFBQVEsSUFBSSxHQUFHLFlBQVksSUFBSTtBQUNuRSxjQUFJLE9BQU8sY0FBYyxPQUFPLElBQUk7QUFDbkMsa0JBQU0sSUFBSSxNQUFNLDZCQUE2QjtBQUFBLG1FQUF5RixNQUFNLFlBQVk7QUFBQSxVQUN6SjtBQUNBLGlCQUFPLGNBQWMsT0FBTyxLQUFLO0FBQUEsUUFDbEM7QUFBQSxNQUNEO0FBQ0EsVUFBSSxnQkFBVSxRQUFWLG1CQUFlLFNBQVM7QUFDM0IsY0FBTSxFQUFFLEtBQUssWUFBWSxVQUFVO0FBQ25DLGNBQU0saUJBQWlCLElBQUksSUFBSSxJQUFJLFFBQVEsUUFBUSxJQUFJLEdBQUcsWUFBWSxJQUFJO0FBQzFFLFlBQUksT0FBTyxjQUFjLGNBQWMsSUFBSTtBQUMxQyxnQkFBTSxJQUFJLE1BQ1Qsd0NBQXdDO0FBQUEsMEVBQWdHLE1BQU0sWUFDL0k7QUFBQSxRQUNEO0FBQ0EsZUFBTyxjQUFjLGNBQWMsS0FBSztBQUFBLE1BQ3pDO0FBQUEsSUFDRDtBQUNBLFVBQU0sYUFBYSxPQUFPLFlBQVksSUFBSSxDQUFDLGVBQWUsV0FBVyxVQUFVLE1BQU0sU0FBUyxXQUFXLE1BQU0sQ0FBQyxFQUFFLE9BQU8sT0FBTztBQUNoSSxhQUFTLE1BQU0sYUFBYTtBQUFBLE1BQzNCO0FBQUEsTUFDQSxPQUFPO0FBQUEsTUFDUCxTQUFTLE1BQU0sV0FBVztBQUFBLFFBQ3pCO0FBQUEsUUFDQSxVQUFVLElBQUksSUFBSSxLQUFLLE1BQU0sYUFBYSxZQUFZLFdBQVc7QUFBQSxRQUNqRTtBQUFBLE1BQ0QsQ0FBQztBQUFBLElBQ0Y7QUFBQSxFQUNEO0FBRUEsU0FBTyxFQUFFLFFBQVEsU0FBUztBQUMzQjtBQUVBLHNDQUFzQyxNQUErQixPQUE0QztBQUNoSCxRQUFNLEVBQUUsYUFBYSxTQUFTLFlBQVksZUFBZTtBQUN6RCxNQUFJLENBQUM7QUFBWSxVQUFNLElBQUksTUFBTSxpQ0FBaUM7QUFDbEUsUUFBTSxXQUFXLElBQUksSUFBSSxLQUFLLE1BQU0sYUFBYSxZQUFZLFdBQVc7QUFDeEUsUUFBTSxNQUFPLE1BQU0sV0FBVyxjQUFjLGNBQWMsUUFBUSxDQUFDO0FBQ25FLFFBQU0sU0FBUyxNQUFNLG1CQUFtQixLQUFLLE9BQU8sT0FBTyxPQUFPO0FBQ2xFLGFBQVcsSUFBSSxPQUFPLE1BQU07QUFDNUIsU0FBTztBQUNSOyIsCiAgIm5hbWVzIjogW10KfQo=

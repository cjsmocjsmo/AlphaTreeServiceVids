import fs from "fs";
import * as colors from "kleur/colors";
import { polyfill } from "@astrojs/webapi";
import { performance } from "perf_hooks";
import * as vite from "vite";
import { createVite } from "../create-vite.js";
import { debug, defaultLogOptions, info, levels, timerMessage, warn } from "../logger.js";
import { createRouteManifest } from "../routing/index.js";
import { generateSitemap } from "../render/sitemap.js";
import { collectPagesData } from "./page-data.js";
import { build as scanBasedBuild } from "./scan-based-build.js";
import { staticBuild } from "./static-build.js";
import { RouteCache } from "../render/route-cache.js";
async function build(config, options = { logging: defaultLogOptions }) {
  polyfill(globalThis, {
    exclude: "window document"
  });
  const builder = new AstroBuilder(config, options);
  await builder.build();
}
class AstroBuilder {
  constructor(config, options) {
    this.mode = "production";
    if (!config.buildOptions.site && config.buildOptions.sitemap !== false) {
      warn(options.logging, "config", `Set "buildOptions.site" to generate correct canonical URLs and sitemap`);
    }
    if (options.mode)
      this.mode = options.mode;
    this.config = config;
    const port = config.devOptions.port;
    this.logging = options.logging;
    this.routeCache = new RouteCache(this.logging);
    this.origin = config.buildOptions.site ? new URL(config.buildOptions.site).origin : `http://localhost:${port}`;
    this.manifest = createRouteManifest({ config }, this.logging);
  }
  async build() {
    const { logging, origin } = this;
    const timer = {};
    timer.init = performance.now();
    timer.viteStart = performance.now();
    const viteConfig = await createVite(vite.mergeConfig({
      mode: this.mode,
      server: {
        hmr: { overlay: false },
        middlewareMode: "ssr"
      }
    }, this.config.vite || {}), { astroConfig: this.config, logging, mode: "build" });
    this.viteConfig = viteConfig;
    const viteServer = await vite.createServer(viteConfig);
    this.viteServer = viteServer;
    debug("build", timerMessage("Vite started", timer.viteStart));
    timer.loadStart = performance.now();
    const { assets, allPages } = await collectPagesData({
      astroConfig: this.config,
      logging: this.logging,
      manifest: this.manifest,
      origin,
      routeCache: this.routeCache,
      viteServer: this.viteServer
    });
    Object.entries(allPages).forEach(([page, data]) => {
      if ("frontmatter" in data.preload[1]) {
        const frontmatter = data.preload[1].frontmatter;
        if (Boolean(frontmatter.draft) && !this.config.buildOptions.drafts) {
          debug("build", timerMessage(`Skipping draft page ${page}`, timer.loadStart));
          delete allPages[page];
        }
      }
    });
    debug("build", timerMessage("All pages loaded", timer.loadStart));
    const pageNames = [];
    timer.buildStart = performance.now();
    if (!this.config.buildOptions.legacyBuild) {
      await staticBuild({
        allPages,
        astroConfig: this.config,
        logging: this.logging,
        manifest: this.manifest,
        origin: this.origin,
        pageNames,
        routeCache: this.routeCache,
        viteConfig: this.viteConfig
      });
    } else {
      await scanBasedBuild({
        allPages,
        astroConfig: this.config,
        logging: this.logging,
        origin: this.origin,
        pageNames,
        routeCache: this.routeCache,
        viteConfig: this.viteConfig,
        viteServer: this.viteServer
      });
    }
    debug("build", timerMessage("Vite build finished", timer.buildStart));
    timer.assetsStart = performance.now();
    Object.keys(assets).map((k) => {
      if (!assets[k])
        return;
      const filePath = new URL(`file://${k}`);
      fs.mkdirSync(new URL("./", filePath), { recursive: true });
      fs.writeFileSync(filePath, assets[k], "utf8");
      delete assets[k];
    });
    debug("build", timerMessage("Additional assets copied", timer.assetsStart));
    if (this.config.buildOptions.sitemap && this.config.buildOptions.site) {
      timer.sitemapStart = performance.now();
      const sitemapFilter = this.config.buildOptions.sitemapFilter ? this.config.buildOptions.sitemapFilter : void 0;
      const sitemap = generateSitemap(pageNames.map((pageName) => new URL(pageName, this.config.buildOptions.site).href), sitemapFilter);
      const sitemapPath = new URL("./sitemap.xml", this.config.dist);
      await fs.promises.mkdir(new URL("./", sitemapPath), { recursive: true });
      await fs.promises.writeFile(sitemapPath, sitemap, "utf8");
      debug("build", timerMessage("Sitemap built", timer.sitemapStart));
    }
    await viteServer.close();
    if (logging.level && levels[logging.level] <= levels["info"]) {
      await this.printStats({ logging, timeStart: timer.init, pageCount: pageNames.length });
    }
  }
  async printStats({ logging, timeStart, pageCount }) {
    const buildTime = performance.now() - timeStart;
    const total = buildTime < 750 ? `${Math.round(buildTime)}ms` : `${(buildTime / 1e3).toFixed(2)}s`;
    const perPage = `${Math.round(buildTime / pageCount)}ms`;
    info(logging, "build", `${pageCount} pages built in ${colors.bold(total)} ${colors.dim(`(${perPage}/page)`)}`);
    info(logging, "build", `\u{1F680} ${colors.cyan(colors.bold("Done"))}`);
  }
}
export {
  build as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGQvaW5kZXgudHMiXSwKICAibWFwcGluZ3MiOiAiQUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQVFBLHFCQUFvQyxRQUFxQixVQUF3QixFQUFFLFNBQVMsa0JBQWtCLEdBQWtCO0FBRS9ILFdBQVMsWUFBWTtBQUFBLElBQ3BCLFNBQVM7QUFBQSxFQUNWLENBQUM7QUFFRCxRQUFNLFVBQVUsSUFBSSxhQUFhLFFBQVEsT0FBTztBQUNoRCxRQUFNLFFBQVEsTUFBTTtBQUNyQjtBQUVBLE1BQU0sYUFBYTtBQUFBLEVBVWxCLFlBQVksUUFBcUIsU0FBdUI7QUFQaEQsZ0JBQU87QUFRZCxRQUFJLENBQUMsT0FBTyxhQUFhLFFBQVEsT0FBTyxhQUFhLFlBQVksT0FBTztBQUN2RSxXQUFLLFFBQVEsU0FBUyxVQUFVLHdFQUF3RTtBQUFBLElBQ3pHO0FBRUEsUUFBSSxRQUFRO0FBQU0sV0FBSyxPQUFPLFFBQVE7QUFDdEMsU0FBSyxTQUFTO0FBQ2QsVUFBTSxPQUFPLE9BQU8sV0FBVztBQUMvQixTQUFLLFVBQVUsUUFBUTtBQUN2QixTQUFLLGFBQWEsSUFBSSxXQUFXLEtBQUssT0FBTztBQUM3QyxTQUFLLFNBQVMsT0FBTyxhQUFhLE9BQU8sSUFBSSxJQUFJLE9BQU8sYUFBYSxJQUFJLEVBQUUsU0FBUyxvQkFBb0I7QUFDeEcsU0FBSyxXQUFXLG9CQUFvQixFQUFFLE9BQU8sR0FBRyxLQUFLLE9BQU87QUFBQSxFQUM3RDtBQUFBLFFBRU0sUUFBUTtBQUNiLFVBQU0sRUFBRSxTQUFTLFdBQVc7QUFDNUIsVUFBTSxRQUFnQyxDQUFDO0FBQ3ZDLFVBQU0sT0FBTyxZQUFZLElBQUk7QUFDN0IsVUFBTSxZQUFZLFlBQVksSUFBSTtBQUNsQyxVQUFNLGFBQWEsTUFBTSxXQUN4QixLQUFLLFlBQ0o7QUFBQSxNQUNDLE1BQU0sS0FBSztBQUFBLE1BQ1gs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

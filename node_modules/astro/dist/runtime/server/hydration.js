import { hydrationSpecifier, serializeListValue } from "./util.js";
import serializeJavaScript from "serialize-javascript";
function serializeProps(value) {
  return serializeJavaScript(value);
}
const HydrationDirectives = ["load", "idle", "media", "visible", "only"];
function extractDirectives(inputProps) {
  let extracted = {
    hydration: null,
    props: {}
  };
  for (const [key, value] of Object.entries(inputProps)) {
    if (key.startsWith("client:")) {
      if (!extracted.hydration) {
        extracted.hydration = {
          directive: "",
          value: "",
          componentUrl: "",
          componentExport: { value: "" }
        };
      }
      switch (key) {
        case "client:component-path": {
          extracted.hydration.componentUrl = value;
          break;
        }
        case "client:component-export": {
          extracted.hydration.componentExport.value = value;
          break;
        }
        case "client:component-hydration": {
          break;
        }
        default: {
          extracted.hydration.directive = key.split(":")[1];
          extracted.hydration.value = value;
          if (HydrationDirectives.indexOf(extracted.hydration.directive) < 0) {
            throw new Error(`Error: invalid hydration directive "${key}". Supported hydration methods: ${HydrationDirectives.map((d) => `"client:${d}"`).join(", ")}`);
          }
          if (extracted.hydration.directive === "media" && typeof extracted.hydration.value !== "string") {
            throw new Error('Error: Media query must be provided for "client:media", similar to client:media="(max-width: 600px)"');
          }
          break;
        }
      }
    } else if (key === "class:list") {
      extracted.props[key.slice(0, -5)] = serializeListValue(value);
    } else {
      extracted.props[key] = value;
    }
  }
  return extracted;
}
async function generateHydrateScript(scriptOptions, metadata) {
  const { renderer, result, astroId, props } = scriptOptions;
  const { hydrate, componentUrl, componentExport } = metadata;
  if (!componentExport) {
    throw new Error(`Unable to resolve a componentExport for "${metadata.displayName}"! Please open an issue.`);
  }
  let hydrationSource = "";
  if (renderer.hydrationPolyfills) {
    hydrationSource += `await Promise.all([${(await Promise.all(renderer.hydrationPolyfills.map(async (src) => `
  import("${await result.resolve(src)}")`))).join(", ")}]);
`;
  }
  hydrationSource += renderer.source ? `const [{ ${componentExport.value}: Component }, { default: hydrate }] = await Promise.all([import("${await result.resolve(componentUrl)}"), import("${await result.resolve(renderer.source)}")]);
  return (el, children) => hydrate(el)(Component, ${serializeProps(props)}, children);
` : `await import("${await result.resolve(componentUrl)}");
  return () => {};
`;
  const hydrationScript = {
    props: { type: "module", "data-astro-component-hydration": true },
    children: `import setup from '${await result.resolve(hydrationSpecifier(hydrate))}';
setup("${astroId}", {name:"${metadata.displayName}",${metadata.hydrateArgs ? `value: ${JSON.stringify(metadata.hydrateArgs)}` : ""}}, async () => {
  ${hydrationSource}
});
`
  };
  return hydrationScript;
}
export {
  extractDirectives,
  generateHydrateScript,
  serializeProps
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL3J1bnRpbWUvc2VydmVyL2h5ZHJhdGlvbi50cyJdLAogICJtYXBwaW5ncyI6ICJBQUVBO0FBQ0E7QUFJTyx3QkFBd0IsT0FBWTtBQUMxQyxTQUFPLG9CQUFvQixLQUFLO0FBQ2pDO0FBRUEsTUFBTSxzQkFBc0IsQ0FBQyxRQUFRLFFBQVEsU0FBUyxXQUFXLE1BQU07QUFjaEUsMkJBQTJCLFlBQTBEO0FBQzNGLE1BQUksWUFBNEI7QUFBQSxJQUMvQixXQUFXO0FBQUEsSUFDWCxPQUFPLENBQUM7QUFBQSxFQUNUO0FBQ0EsYUFBVyxDQUFDLEtBQUssVUFBVSxPQUFPLFFBQVEsVUFBVSxHQUFHO0FBQ3RELFFBQUksSUFBSSxXQUFXLFNBQVMsR0FBRztBQUM5QixVQUFJLENBQUMsVUFBVSxXQUFXO0FBQ3pCLGtCQUFVLFlBQVk7QUFBQSxVQUNyQixXQUFXO0FBQUEsVUFDWCxPQUFPO0FBQUEsVUFDUCxjQUFjO0FBQUEsVUFDZCxpQkFBaUIsRUFBRSxPQUFPLEdBQUc7QUFBQSxRQUM5QjtBQUFBLE1BQ0Q7QUFDQSxjQUFRO0FBQUEsYUFDRix5QkFBeUI7QUFDN0Isb0JBQVUsVUFBVSxlQUFlO0FBQ25DO0FBQUEsUUFDRDtBQUFBLGFBQ0ssMkJBQTJCO0FBQy9CLG9CQUFVLFVBQVUsZ0JBQWdCLFFBQVE7QUFDNUM7QUFBQSxRQUNEO0FBQUEsYUFHSyw4QkFBOEI7QUFDbEM7QUFBQSxRQUNEO0FBQUEsaUJBQ1M7QUFDUixvQkFBVSxVQUFVLFlBQVksSUFBSSxNQUFNLEdBQUcsRUFBRTtBQUMvQyxvQkFBVSxVQUFVLFFBQVE7QUFHNUIsY0FBSSxvQkFBb0IsUUFBUSxVQUFVLFVBQVUsU0FBUyxJQUFJLEdBQUc7QUFDbkUsa0JBQU0sSUFBSSxNQUFNLHVDQUF1QyxzQ0FBc0Msb0JBQW9CLElBQUksQ0FBQyxNQUFNLFdBQVcsSUFBSSxFQUFFLEtBQUssSUFBSSxHQUFHO0FBQUEsVUFDMUo7QUFHQSxjQUFJLFVBQVUsVUFBVSxjQUFjLFdBQVcsT0FBTyxVQUFVLFVBQVUsVUFBVSxVQUFVO0FBQy9GLGtCQUFNLElBQUksTUFBTSxzR0FBc0c7QUFBQSxVQUN2SDtBQUVBO0FBQUEsUUFDRDtBQUFBO0FBQUEsSUFFRixXQUFXLFFBQVEsY0FBYztBQUVoQyxnQkFBVSxNQUFNLElBQUksTUFBTSxHQUFHLEVBQUUsS0FBSyxtQkFBbUIsS0FBSztBQUFBLElBQzdELE9BQU87QUFDTixnQkFBVSxNQUFNLE9BQU87QUFBQSxJQUN4QjtBQUFBLEVBQ0Q7QUFFQSxTQUFPO0FBQ1I7QUFVQSxxQ0FBNEMsZUFBcUMsVUFBaUU7QUFDakosUUFBTSxFQUFFLFVBQVUsUUFBUSxTQUFTLFVBQVU7QUFDN0MsUUFBTSxFQUFFLFNBQVMsY0FBYyxvQkFBb0I7QUFFbkQsTUFBSSxDQUFDLGlCQUFpQjtBQUNyQixVQUFNLElBQUksTUFBTSw0Q0FBNEMsU0FBUyxxQ0FBcUM7QUFBQSxFQUMzRztBQUVBLE1BQUksa0JBQWtCO0FBQ3RCLE1BQUksU0FBUyxvQkFBb0I7QUFDaEMsdUJBQW1CLHNCQUF1QixPQUFNLFFBQVEsSUFBSSxTQUFTLG1CQUFtQixJQUFJLE9BQU8sUUFBZ0I7QUFBQSxZQUFlLE1BQU0sT0FBTyxRQUFRLEdBQUcsS0FBSyxDQUFDLEdBQUcsS0FDbEssSUFDRDtBQUFBO0FBQUEsRUFDRDtBQUVBLHFCQUFtQixTQUFTLFNBQ3pCLFlBQVksZ0JBQWdCLDBFQUEwRSxNQUFNLE9BQU8sUUFBUSxZQUFZLGdCQUFnQixNQUFNLE9BQU8sUUFDcEssU0FBUyxNQUNUO0FBQUEsb0RBQ2dELGVBQWUsS0FBSztBQUFBLElBRXBFLGlCQUFpQixNQUFNLE9BQU8sUUFBUSxZQUFZO0FBQUE7QUFBQTtBQUlyRCxRQUFNLGtCQUFrQjtBQUFBLElBQ3ZCLE9BQU8sRUFBRSxNQUFNLFVBQVUsa0NBQWtDLEtBQUs7QUFBQSxJQUNoRSxVQUFVLHNCQUFzQixNQUFNLE9BQU8sUUFBUSxtQkFBbUIsT0FBTyxDQUFDO0FBQUEsU0FDekUsb0JBQW9CLFNBQVMsZ0JBQWdCLFNBQVMsY0FBYyxVQUFVLEtBQUssVUFBVSxTQUFTLFdBQVcsTUFBTTtBQUFBLElBQzVIO0FBQUE7QUFBQTtBQUFBLEVBR0g7QUFFQSxTQUFPO0FBQ1I7IiwKICAibmFtZXMiOiBbXQp9Cg==

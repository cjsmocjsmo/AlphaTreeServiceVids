import * as path from "path";
import esbuild from "esbuild";
import { isCSSRequest } from "../core/render/dev/css.js";
const PLUGIN_NAME = "@astrojs/rollup-plugin-build-css";
const ASTRO_STYLE_PREFIX = "@astro-inline-style";
const ASTRO_PAGE_STYLE_PREFIX = "@astro-page-all-styles";
function getAstroPageStyleId(pathname) {
  let styleId = ASTRO_PAGE_STYLE_PREFIX + pathname;
  if (styleId.endsWith("/")) {
    styleId += "index";
  }
  styleId += ".js";
  return styleId;
}
function getAstroStyleId(pathname) {
  let styleId = ASTRO_STYLE_PREFIX + pathname;
  if (styleId.endsWith("/")) {
    styleId += "index";
  }
  return styleId;
}
function getAstroStylePathFromId(id) {
  return id.substr(ASTRO_STYLE_PREFIX.length + 1);
}
function isStyleVirtualModule(id) {
  return id.startsWith(ASTRO_STYLE_PREFIX);
}
function isPageStyleVirtualModule(id) {
  return id.startsWith(ASTRO_PAGE_STYLE_PREFIX);
}
function rollupPluginAstroBuildCSS(options) {
  const { internals } = options;
  const styleSourceMap = /* @__PURE__ */ new Map();
  return {
    name: PLUGIN_NAME,
    configResolved(resolvedConfig) {
      const plugins = resolvedConfig.plugins;
      const viteCSSPostIndex = resolvedConfig.plugins.findIndex((p) => p.name === "vite:css-post");
      if (viteCSSPostIndex !== -1) {
        const viteCSSPost = plugins[viteCSSPostIndex];
        delete viteCSSPost.renderChunk;
        delete viteCSSPost.generateBundle;
        const ourIndex = plugins.findIndex((p) => p.name === PLUGIN_NAME);
        const ourPlugin = plugins[ourIndex];
        plugins.splice(ourIndex, 1);
        plugins.splice(viteCSSPostIndex - 1, 0, ourPlugin);
      }
    },
    async resolveId(id) {
      if (isPageStyleVirtualModule(id)) {
        return id;
      }
      if (isStyleVirtualModule(id)) {
        return id;
      }
      return void 0;
    },
    async load(id) {
      if (isPageStyleVirtualModule(id)) {
        return internals.astroPageStyleMap.get(id) || null;
      }
      if (isStyleVirtualModule(id)) {
        return internals.astroStyleMap.get(id) || null;
      }
      return null;
    },
    async transform(value, id) {
      if (isStyleVirtualModule(id)) {
        styleSourceMap.set(id, value);
      }
      if (isCSSRequest(id)) {
        styleSourceMap.set(id, value);
      }
      return null;
    },
    async renderChunk(_code, chunk) {
      let chunkCSS = "";
      let isPureCSS = true;
      for (const [id] of Object.entries(chunk.modules)) {
        if (!isCSSRequest(id) && !isPageStyleVirtualModule(id)) {
          isPureCSS = false;
        }
        if (styleSourceMap.has(id)) {
          chunkCSS += styleSourceMap.get(id);
        }
      }
      if (!chunkCSS)
        return null;
      if (isPureCSS) {
        internals.pureCSSChunks.add(chunk);
      }
      const { code: minifiedCSS } = await esbuild.transform(chunkCSS, {
        loader: "css",
        minify: true
      });
      const referenceId = this.emitFile({
        name: chunk.name + ".css",
        type: "asset",
        source: minifiedCSS
      });
      internals.chunkToReferenceIdMap.set(chunk.fileName, referenceId);
      if (chunk.type === "chunk") {
        const fileName = this.getFileName(referenceId);
        if (chunk.facadeModuleId) {
          const facadeId = chunk.facadeModuleId;
          if (!internals.facadeIdToAssetsMap.has(facadeId)) {
            internals.facadeIdToAssetsMap.set(facadeId, []);
          }
          internals.facadeIdToAssetsMap.get(facadeId).push(fileName);
        }
      }
      return null;
    },
    generateBundle(opts, bundle) {
      const hasPureCSSChunks = internals.pureCSSChunks.size;
      const pureChunkFilenames = new Set([...internals.pureCSSChunks].map((chunk) => chunk.fileName));
      const emptyChunkFiles = [...pureChunkFilenames].map((file) => path.basename(file)).join("|").replace(/\./g, "\\.");
      const emptyChunkRE = new RegExp(opts.format === "es" ? `\\bimport\\s*"[^"]*(?:${emptyChunkFiles})";
?` : `\\brequire\\(\\s*"[^"]*(?:${emptyChunkFiles})"\\);
?`, "g");
      for (const [chunkId, chunk] of Object.entries(bundle)) {
        if (chunk.type === "chunk") {
          if (chunk.facadeModuleId) {
            if (!internals.facadeIdToAssetsMap.has(chunk.facadeModuleId)) {
              internals.facadeIdToAssetsMap.set(chunk.facadeModuleId, []);
            }
            const assets = internals.facadeIdToAssetsMap.get(chunk.facadeModuleId);
            const assetSet = new Set(assets);
            for (const imp of chunk.imports) {
              if (internals.chunkToReferenceIdMap.has(imp) && !pureChunkFilenames.has(imp)) {
                const referenceId = internals.chunkToReferenceIdMap.get(imp);
                const fileName = this.getFileName(referenceId);
                if (!assetSet.has(fileName)) {
                  assetSet.add(fileName);
                  assets.push(fileName);
                }
              }
            }
          }
          if (hasPureCSSChunks) {
            if (internals.pureCSSChunks.has(chunk)) {
              delete bundle[chunkId];
            } else {
              chunk.code = chunk.code.replace(emptyChunkRE, (m) => `/* empty css ${"".padEnd(m.length - 15)}*/`);
            }
          }
        }
      }
    }
  };
}
export {
  getAstroPageStyleId,
  getAstroStyleId,
  getAstroStylePathFromId,
  rollupPluginAstroBuildCSS
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL3ZpdGUtcGx1Z2luLWJ1aWxkLWNzcy9pbmRleC50cyJdLAogICJtYXBwaW5ncyI6ICJBQUVBO0FBQ0E7QUFFQTtBQUVBLE1BQU0sY0FBYztBQUdwQixNQUFNLHFCQUFxQjtBQUUzQixNQUFNLDBCQUEwQjtBQUV6Qiw2QkFBNkIsVUFBa0I7QUFDckQsTUFBSSxVQUFVLDBCQUEwQjtBQUN4QyxNQUFJLFFBQVEsU0FBUyxHQUFHLEdBQUc7QUFDMUIsZUFBVztBQUFBLEVBQ1o7QUFDQSxhQUFXO0FBQ1gsU0FBTztBQUNSO0FBRU8seUJBQXlCLFVBQWtCO0FBQ2pELE1BQUksVUFBVSxxQkFBcUI7QUFDbkMsTUFBSSxRQUFRLFNBQVMsR0FBRyxHQUFHO0FBQzFCLGVBQVc7QUFBQSxFQUNaO0FBQ0EsU0FBTztBQUNSO0FBRU8saUNBQWlDLElBQVk7QUFDbkQsU0FBTyxHQUFHLE9BQU8sbUJBQW1CLFNBQVMsQ0FBQztBQUMvQztBQUVBLDhCQUE4QixJQUFZO0FBQ3pDLFNBQU8sR0FBRyxXQUFXLGtCQUFrQjtBQUN4QztBQUVBLGtDQUFrQyxJQUFZO0FBQzdDLFNBQU8sR0FBRyxXQUFXLHVCQUF1QjtBQUM3QztBQU1PLG1DQUFtQyxTQUFvQztBQUM3RSxRQUFNLEVBQUUsY0FBYztBQUN0QixRQUFNLGlCQUFpQixvQkFBSSxJQUFvQjtBQUUvQyxTQUFPO0FBQUEsSUFDTixNQUFNO0FBQUEsSUFFTixlQUFlLGdCQUFnQjtBQUs5QixZQUFNLFVBQVUsZUFBZTtBQUMvQixZQUFNLG1CQUFtQixlQUFlLFFBQVEsVUFBVSxDQUFDLE1BQU0sRUFBRSxTQUFTLGVBQWU7QUFDM0YsVUFBSSxxQkFBcUIsSUFBSTtBQUM1QixjQUFNLGNBQWMsUUFBUTtBQUc1QixlQUFPLFlBQVk7QUFDbkIsZUFBTyxZQUFZO0FBR25CLGNBQU0sV0FBVyxRQUFRLFVBQVUsQ0FBQyxNQUFNLEVBQUUsU0FBUyxXQUFXO0FBQ2hFLGNBQU0sWUFBWSxRQUFRO0FBRzFCLGdC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
